<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>EmailSamplesDB &mdash; LearningCurveApp 1.0 documentation</title>
    
    <link rel="stylesheet" href="../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="author" title="About these documents" href="../about.html" />
    <link rel="top" title="LearningCurveApp 1.0 documentation" href="../index.html" />
    <link rel="up" title="Module code" href="index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../index.html">LearningCurveApp 1.0 documentation</a> &raquo;</li>
          <li><a href="index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for EmailSamplesDB</h1><div class="highlight"><pre>
<span class="c"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Running this module as __main__ creates a feature vector database without using a GUI</span>

<span class="sd">Created on Tue Feb 09 16:03:00 2016</span>

<span class="sd">@author: Joseph R. Cole</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="c">#import pdb</span>
<span class="kn">import</span> <span class="nn">traceback</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">sqlite3</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="kn">import</span> <span class="n">minimize</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">from</span> <span class="nn">FeatureVecGen</span> <span class="kn">import</span> <span class="n">FeatureVecGen</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">TempDB</span> <span class="kn">import</span> <span class="n">TempDB</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">cPickle</span>
<span class="kn">import</span> <span class="nn">threading</span>

<div class="viewcode-block" id="EmailSamplesDB"><a class="viewcode-back" href="../apiref.html#EmailSamplesDB.EmailSamplesDB">[docs]</a><span class="k">class</span> <span class="nc">EmailSamplesDB</span> <span class="p">:</span>
	<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	Controls the connection to the feature vector database.  In the future this will be implemented more</span>
<span class="sd">	generically to serve as a base class that provides the interface to the LearningCurveAppMainGUI. A </span>
<span class="sd">	developer could then inherit from this class to connect to any given feature vector database.  Currently,</span>
<span class="sd">	this class works with the email/spam feature vector database used in the tutorial.  All SQL commands are</span>
<span class="sd">	placed in an external JSON file so that the queries do not need to be hard coded.</span>
<span class="sd">	&quot;&quot;&quot;</span>
	<span class="n">DB_Connect</span> <span class="o">=</span> <span class="bp">None</span>
	<span class="n">DB_Cursor</span> <span class="o">=</span> <span class="bp">None</span>
	<span class="n">params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

<div class="viewcode-block" id="EmailSamplesDB.__init__"><a class="viewcode-back" href="../apiref.html#EmailSamplesDB.EmailSamplesDB.__init__">[docs]</a>	<span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">sqlcmdpath</span><span class="p">,</span><span class="n">pragmacmdpath</span><span class="p">,</span><span class="n">tempsqlcmdpath</span><span class="p">,</span><span class="o">**</span><span class="n">params</span><span class="p">)</span> <span class="p">:</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Load external data and parameters in preparation to work with a feature vector database.</span>

<span class="sd">		sqlcmdpath -</span>
<span class="sd">			json file with SQL commands for queries on the sqlite3 database</span>
<span class="sd">		pragmacmdpath -</span>
<span class="sd">			json file with PRAGMA commands for initializing the sqlite3 database</span>
<span class="sd">		tempsqlcmdpath -</span>
<span class="sd">			json file with SQL commands for queries on a temporary database when it is necessary to</span>
<span class="sd">			read data/process it/write data back to the main database (using multiple cursors at the</span>
<span class="sd">			same time doesn&#39;t seem to be supported in sqlite3)</span>
<span class="sd">		params -</span>
<span class="sd">			a dict() with parameters controlling creation of feature vectors and other configurable options</span>

<span class="sd">			params[&#39;CommitFreq&#39;] -</span>
<span class="sd">				number of writes to add to the database journal before a commit when doing large blocks of writes</span>
<span class="sd">			params[&#39;TempDBCMDs&#39;] -</span>
<span class="sd">				stores the tempsqlcmdpath for use with the temporary database when needed</span>
<span class="sd">			params[&#39;MinCountFrac&#39;] -</span>
<span class="sd">				Used for creating the words lists against which feature vectors are created.</span>
<span class="sd">				Minimum frequency of word occurance in the training set before the word is included in the word list</span>
<span class="sd">				(specified as a fraction of the total number of words in the training set)</span>
<span class="sd">			params[&#39;MaxCountFrac&#39;] -</span>
<span class="sd">				Used for creating the words lists against which feature vectors are created.</span>
<span class="sd">				Maximum frequency of word occurance in the training set allowing the word to be included in the word list</span>
<span class="sd">				(specified as a fraction of the total number of words in the training set)</span>

<span class="sd">		shared class variables - </span>
<span class="sd">			self.DB_Connect - the sqlite database connection object</span>

<span class="sd">			self.DB_Cursor - the sqlite database cursor object</span>

<span class="sd">			self.DBpath - path to the current database file in use</span>

<span class="sd">			self.DBlock - a lock on the database preventing other threads from accessing it</span>

<span class="sd">			self.SQLCMDs - dict() containing all the available SQL commands</span>

<span class="sd">			self.DBSetup - dict() containing all the available PRAGMA commands</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">DBpath</span> <span class="o">=</span> <span class="bp">None</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">DBlock</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;CommitFreq&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">200</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;TempDBCMDs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tempsqlcmdpath</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;MaxCountFrac&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.003</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;MinCountFrac&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.00003</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
		<span class="k">try</span> <span class="p">:</span>
			<span class="n">fhan</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">sqlcmdpath</span><span class="p">)</span>
			<span class="n">SQLCMDStr</span> <span class="o">=</span> <span class="n">fhan</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
			<span class="n">fhan</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">SQLCMDs</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">SQLCMDStr</span><span class="p">)</span>
		<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">detail</span> <span class="p">:</span>
			<span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;Unable to load SQL commands from </span><span class="si">%s</span><span class="s">: </span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">sqlcmdpath</span><span class="p">,</span><span class="n">detail</span><span class="p">))</span>
		<span class="k">try</span> <span class="p">:</span>
			<span class="n">fhan</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">pragmacmdpath</span><span class="p">)</span>
			<span class="n">PragmaCMDStr</span> <span class="o">=</span> <span class="n">fhan</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
			<span class="n">fhan</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">DBSetup</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">PragmaCMDStr</span><span class="p">)</span>
		<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">detail</span> <span class="p">:</span>
			<span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;Unable to load PRAGMA commands from </span><span class="si">%s</span><span class="s">: </span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">pragmacmdpath</span><span class="p">,</span><span class="n">detail</span><span class="p">))</span>
		<span class="k">return</span>
</div>
	<span class="k">def</span> <span class="nf">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="p">:</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Automatically ensures the database connection is closed and the lock is released when all</span>
<span class="sd">		references to this object are gone.</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">DB_Connect</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">DB_Cursor</span> <span class="o">=</span> <span class="bp">None</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">DB_Connect</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">DBlock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
		<span class="k">return</span>

<div class="viewcode-block" id="EmailSamplesDB.ConnectDB"><a class="viewcode-back" href="../apiref.html#EmailSamplesDB.EmailSamplesDB.ConnectDB">[docs]</a>	<span class="k">def</span> <span class="nf">ConnectDB</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">DBpath</span><span class="p">)</span> <span class="p">:</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Setup a connection to an sqlite3 feature vector database file. Remember to close immediately</span>
<span class="sd">		once your read or write is complete or other threads won&#39;t be able to use the database.</span>

<span class="sd">		DBpath - path to the database file to connect</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">try</span> <span class="p">:</span>
			<span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">DB_Connect</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">,</span> <span class="s">&quot;Need to close previous connection first.&quot;</span>
			<span class="n">got_lock</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">DBlock</span><span class="o">.</span><span class="n">acquire</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>	<span class="c"># Non blocking form of threading.Lock.acquire()</span>
			<span class="k">assert</span> <span class="n">got_lock</span><span class="p">,</span> <span class="s">&quot;Database is in use, couldn&#39;t get the lock.&quot;</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">DB_Connect</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">DBpath</span><span class="p">)</span>
			<span class="k">for</span> <span class="n">cmd</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">DBSetup</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">DB_Connect</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">DB_Cursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">DB_Connect</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">DBpath</span> <span class="o">=</span> <span class="n">DBpath</span>
		<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">detail</span> <span class="p">:</span>
			<span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;Unable to connect to database at </span><span class="si">%s</span><span class="s">: </span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">DBpath</span><span class="p">,</span><span class="n">detail</span><span class="p">))</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">DisconnectDB</span><span class="p">()</span>
		<span class="k">return</span>
</div>
<div class="viewcode-block" id="EmailSamplesDB.ConnectDBblk"><a class="viewcode-back" href="../apiref.html#EmailSamplesDB.EmailSamplesDB.ConnectDBblk">[docs]</a>	<span class="k">def</span> <span class="nf">ConnectDBblk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">DBpath</span><span class="p">)</span> <span class="p">:</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Setup a connection to an sqlite3 feature vector database file. Remember to close immediately</span>
<span class="sd">		once your read or write is complete or other threads won&#39;t be able to use the database. This</span>
<span class="sd">		is the same as ConnectDB() except that it blocks the thread and waits for the lock to be</span>
<span class="sd">		released if the database is in use.</span>

<span class="sd">		DBpath - path to the database file to connect</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">try</span> <span class="p">:</span>
			<span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">DB_Connect</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">,</span> <span class="s">&quot;Need to close previous connection first.&quot;</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">DBlock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>	<span class="c"># Blocking form of threading.Lock.acquire()</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">DB_Connect</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">DBpath</span><span class="p">)</span>
			<span class="k">for</span> <span class="n">cmd</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">DBSetup</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">DB_Connect</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">DB_Cursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">DB_Connect</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">DBpath</span> <span class="o">=</span> <span class="n">DBpath</span>
		<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">detail</span> <span class="p">:</span>
			<span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;Unable to connect to database at </span><span class="si">%s</span><span class="s">: </span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">DBpath</span><span class="p">,</span><span class="n">detail</span><span class="p">))</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">DisconnectDB</span><span class="p">()</span>
		<span class="k">return</span>
</div>
<div class="viewcode-block" id="EmailSamplesDB.DisconnectDB"><a class="viewcode-back" href="../apiref.html#EmailSamplesDB.EmailSamplesDB.DisconnectDB">[docs]</a>	<span class="k">def</span> <span class="nf">DisconnectDB</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="p">:</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Disconnect a database and release the lock.</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">try</span> <span class="p">:</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">DB_Connect</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">DB_Cursor</span> <span class="o">=</span> <span class="bp">None</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">DB_Connect</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
				<span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Disconnected the database: </span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">DBpath</span><span class="p">)</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">DB_Connect</span> <span class="o">=</span> <span class="bp">None</span>
			<span class="k">else</span> <span class="p">:</span>
				<span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;No database to disconnect.&quot;</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">DBlock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
		<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">detail</span> <span class="p">:</span>
			<span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;Failed to disconnect the database: </span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="n">detail</span><span class="p">)</span>
		<span class="k">return</span>
</div>
<div class="viewcode-block" id="EmailSamplesDB.CreateDB"><a class="viewcode-back" href="../apiref.html#EmailSamplesDB.EmailSamplesDB.CreateDB">[docs]</a>	<span class="k">def</span> <span class="nf">CreateDB</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="p">:</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Initialize the tables for a new database file.</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">try</span> <span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">DB_Cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SQLCMDs</span><span class="p">[</span><span class="s">&#39;CreateClassTable&#39;</span><span class="p">])</span>
			<span class="k">for</span> <span class="n">ii</span><span class="p">,</span><span class="n">classname</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SQLCMDs</span><span class="p">[</span><span class="s">&#39;ClassesList&#39;</span><span class="p">])</span> <span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">DB_Cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SQLCMDs</span><span class="p">[</span><span class="s">&#39;InsertClass&#39;</span><span class="p">],(</span><span class="n">ii</span><span class="p">,</span><span class="n">classname</span><span class="p">))</span>

			<span class="bp">self</span><span class="o">.</span><span class="n">DB_Cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SQLCMDs</span><span class="p">[</span><span class="s">&#39;CreateSetTable&#39;</span><span class="p">])</span>
			<span class="k">for</span> <span class="n">ii</span><span class="p">,</span><span class="n">setname</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SQLCMDs</span><span class="p">[</span><span class="s">&#39;SetList&#39;</span><span class="p">])</span> <span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">DB_Cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SQLCMDs</span><span class="p">[</span><span class="s">&#39;InsertSet&#39;</span><span class="p">],(</span><span class="n">ii</span><span class="p">,</span><span class="n">setname</span><span class="p">))</span>

			<span class="bp">self</span><span class="o">.</span><span class="n">DB_Cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SQLCMDs</span><span class="p">[</span><span class="s">&#39;CreateSampleTable&#39;</span><span class="p">])</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">DB_Cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SQLCMDs</span><span class="p">[</span><span class="s">&#39;CreateDictListTable&#39;</span><span class="p">])</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">DB_Cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SQLCMDs</span><span class="p">[</span><span class="s">&#39;CreateDictBuildTable&#39;</span><span class="p">])</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">DB_Cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SQLCMDs</span><span class="p">[</span><span class="s">&#39;CreateWordLists&#39;</span><span class="p">])</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">DB_Cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SQLCMDs</span><span class="p">[</span><span class="s">&#39;CreateFeatureTable&#39;</span><span class="p">])</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">DB_Connect</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
		<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">detail</span><span class="p">:</span>
			<span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;Failed to create the database: </span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="n">detail</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">DB_Connect</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
		<span class="k">return</span>
</div>
<div class="viewcode-block" id="EmailSamplesDB.ResetDB"><a class="viewcode-back" href="../apiref.html#EmailSamplesDB.EmailSamplesDB.ResetDB">[docs]</a>	<span class="k">def</span> <span class="nf">ResetDB</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="p">:</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Delete all the tables in a database.</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">try</span> <span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">DB_Cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SQLCMDs</span><span class="p">[</span><span class="s">&#39;SelectDictTables&#39;</span><span class="p">])</span>
			<span class="n">DictTables</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">DB_Cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
			<span class="k">for</span> <span class="n">table</span> <span class="ow">in</span> <span class="n">DictTables</span> <span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">DB_Cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SQLCMDs</span><span class="p">[</span><span class="s">&#39;DropTable&#39;</span><span class="p">]</span><span class="o">%</span><span class="n">table</span><span class="p">)</span>

			<span class="bp">self</span><span class="o">.</span><span class="n">DB_Cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SQLCMDs</span><span class="p">[</span><span class="s">&#39;SelectWordLists&#39;</span><span class="p">])</span>
			<span class="n">WordListTables</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">DB_Cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
			<span class="k">for</span> <span class="n">table</span> <span class="ow">in</span> <span class="n">WordListTables</span> <span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">DB_Cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SQLCMDs</span><span class="p">[</span><span class="s">&#39;DropTable&#39;</span><span class="p">]</span><span class="o">%</span><span class="n">table</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

			<span class="k">for</span> <span class="n">table</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">SQLCMDs</span><span class="p">[</span><span class="s">&#39;TableList&#39;</span><span class="p">]</span> <span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">DB_Cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SQLCMDs</span><span class="p">[</span><span class="s">&#39;DropTable&#39;</span><span class="p">]</span><span class="o">%</span><span class="p">(</span><span class="n">table</span><span class="p">,))</span>

			<span class="bp">self</span><span class="o">.</span><span class="n">DB_Connect</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
		<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">detail</span><span class="p">:</span>
			<span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;Failed to reset the database: </span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="n">detail</span><span class="o">.</span><span class="n">message</span><span class="p">)</span>
		<span class="k">return</span>
</div>
<div class="viewcode-block" id="EmailSamplesDB.AddToDB"><a class="viewcode-back" href="../apiref.html#EmailSamplesDB.EmailSamplesDB.AddToDB">[docs]</a>	<span class="k">def</span> <span class="nf">AddToDB</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">dirpath</span><span class="p">,</span><span class="n">classname</span><span class="p">,</span><span class="n">samp_distr_targ</span><span class="p">)</span> <span class="p">:</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Add new sample emails to a database. No processing of the emails is done except to attempt</span>
<span class="sd">		conversion to utf-8.</span>

<span class="sd">		dirpath -</span>
<span class="sd">			a path to a directory of email files to add to the database</span>
<span class="sd">		classname -</span>
<span class="sd">			a reference to the class of the samples in the given directory (legitimate email or spam)</span>
<span class="sd">		samp_distr_targ -</span>
<span class="sd">			a tuple containing the desired fraction of samples assigned to each set (training,cross</span>
<span class="sd">			validation,test).  New samples are distributed to optimally match this desired distribution</span>
<span class="sd">			based on the number of new samples provided and the current distribution between sets of </span>
<span class="sd">			samples already in the database. Each value in the tuple should be in the range [0,1], and</span>
<span class="sd">			the total of all values in the tuple should be 1.</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">CurSampleCount</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">GetSampleCount</span><span class="p">()</span>
		<span class="k">try</span> <span class="p">:</span>
			<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">classname</span><span class="p">,</span><span class="nb">str</span><span class="p">)</span> <span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">DB_Cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SQLCMDs</span><span class="p">[</span><span class="s">&#39;SelectClassID&#39;</span><span class="p">],(</span><span class="n">classname</span><span class="p">,))</span>
				<span class="n">classid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">DB_Cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
			<span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">classname</span><span class="p">,</span><span class="nb">int</span><span class="p">)</span> <span class="p">:</span>
				<span class="n">classid</span> <span class="o">=</span> <span class="n">classname</span>
			<span class="k">else</span> <span class="p">:</span>
				<span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&quot;classname must be str or int&quot;</span><span class="p">)</span>

			<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">dirpath</span><span class="p">)</span> <span class="p">:</span>
				<span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s">&quot;Provided directory path does not exist&quot;</span><span class="p">)</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">dirname</span><span class="p">,</span> <span class="n">dirs</span><span class="p">,</span> <span class="n">files</span><span class="p">)</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">dirpath</span><span class="p">)</span> <span class="p">:</span>
				<span class="n">NumSamples</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)</span>
				<span class="n">SetAssignments</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">AssignSamplesToSets</span><span class="p">(</span><span class="n">NumSamples</span><span class="p">,</span><span class="n">samp_distr_targ</span><span class="p">)</span>
				<span class="k">for</span> <span class="n">ii</span><span class="p">,</span><span class="n">filename</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">files</span><span class="p">)</span> <span class="p">:</span>
					<span class="n">thefile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirname</span><span class="p">,</span><span class="n">filename</span><span class="p">)</span>
					<span class="n">fhan</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">thefile</span><span class="p">)</span>
					<span class="n">emailstr</span> <span class="o">=</span> <span class="n">fhan</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
					<span class="n">fhan</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
					<span class="n">HeaderSepPos</span> <span class="o">=</span> <span class="n">emailstr</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n\n</span><span class="s">&#39;</span><span class="p">)</span>
					<span class="k">assert</span> <span class="p">(</span><span class="n">HeaderSepPos</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span><span class="s">&#39;Unable to separate message body.&#39;</span>
					<span class="n">head</span> <span class="o">=</span> <span class="n">emailstr</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">HeaderSepPos</span><span class="p">]</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">,</span><span class="s">&#39;ignore&#39;</span><span class="p">)</span>
					<span class="n">body</span> <span class="o">=</span> <span class="n">emailstr</span><span class="p">[</span><span class="n">HeaderSepPos</span><span class="o">+</span><span class="mi">2</span><span class="p">:]</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">,</span><span class="s">&#39;ignore&#39;</span><span class="p">)</span>
					<span class="n">order</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randrange</span><span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="p">(</span><span class="mi">32</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>	<span class="c"># a value assigned to help ensure all classes of samples are drawn randomly from the database</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">DB_Cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SQLCMDs</span><span class="p">[</span><span class="s">&#39;InsertSample&#39;</span><span class="p">],(</span><span class="n">ii</span><span class="o">+</span><span class="n">CurSampleCount</span><span class="p">,</span><span class="n">filename</span><span class="p">,</span><span class="n">head</span><span class="p">,</span><span class="n">body</span><span class="p">,</span><span class="n">classid</span><span class="p">,</span><span class="n">SetAssignments</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span><span class="n">order</span><span class="p">))</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">DB_Connect</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
		<span class="k">except</span> <span class="ne">TypeError</span> <span class="k">as</span> <span class="n">detail</span> <span class="p">:</span>
			<span class="n">logging</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="n">detail</span><span class="o">.</span><span class="n">message</span><span class="p">)</span>
			<span class="nb">exit</span><span class="p">()</span>
		<span class="k">except</span> <span class="ne">IOError</span> <span class="k">as</span> <span class="n">detail</span> <span class="p">:</span>
			<span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">detail</span><span class="o">.</span><span class="n">message</span><span class="p">)</span>
		<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">detail</span> <span class="p">:</span>
			<span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;Failed to add records to database: </span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="n">detail</span><span class="o">.</span><span class="n">message</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">DB_Connect</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
		<span class="k">return</span>
</div>
<div class="viewcode-block" id="EmailSamplesDB.CreateDict"><a class="viewcode-back" href="../apiref.html#EmailSamplesDB.EmailSamplesDB.CreateDict">[docs]</a>	<span class="k">def</span> <span class="nf">CreateDict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">readable_name</span><span class="p">)</span> <span class="p">:</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Add a new dictionary table to the database.</span>

<span class="sd">		readable_name - a human readable name to assign to the table that is saved alongside the automatically</span>
<span class="sd">		generated name used in the database</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">try</span> <span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">DB_Cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SQLCMDs</span><span class="p">[</span><span class="s">&#39;DictMax&#39;</span><span class="p">])</span>
			<span class="n">NextKey</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">DB_Cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
			<span class="k">if</span> <span class="n">NextKey</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
				<span class="n">NextKey</span> <span class="o">+=</span> <span class="mi">1</span>
			<span class="k">else</span> <span class="p">:</span>
				<span class="n">NextKey</span> <span class="o">=</span> <span class="mi">0</span>
			<span class="n">DictName</span> <span class="o">=</span> <span class="s">&quot;dict</span><span class="si">%d</span><span class="s">&quot;</span><span class="o">%</span><span class="n">NextKey</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">DB_Cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SQLCMDs</span><span class="p">[</span><span class="s">&#39;CreateDictTable&#39;</span><span class="p">]</span><span class="o">%</span><span class="n">DictName</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">DB_Cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SQLCMDs</span><span class="p">[</span><span class="s">&#39;InsertDict&#39;</span><span class="p">],(</span><span class="n">NextKey</span><span class="p">,</span><span class="n">DictName</span><span class="p">,</span><span class="n">readable_name</span><span class="p">))</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">DB_Connect</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
		<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">detail</span> <span class="p">:</span>
			<span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;Failed to create a new dictionary table: </span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="n">detail</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">DB_Connect</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
		<span class="k">return</span> <span class="n">NextKey</span>
</div>
<div class="viewcode-block" id="EmailSamplesDB.CreateWordList"><a class="viewcode-back" href="../apiref.html#EmailSamplesDB.EmailSamplesDB.CreateWordList">[docs]</a>	<span class="k">def</span> <span class="nf">CreateWordList</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">readable_name</span><span class="p">,</span><span class="n">DictRef</span><span class="p">)</span> <span class="p">:</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Add a new word list table to the database.</span>

<span class="sd">		readable_name - a human readable name to assign to the table that is saved alongside the automatically</span>
<span class="sd">		generated name used in the database</span>
<span class="sd">		DictRef - a reference to the dictionary table in the database from which the words in this list are</span>
<span class="sd">		taken</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">try</span> <span class="p">:</span>
			<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">DictRef</span><span class="p">,</span><span class="nb">str</span><span class="p">)</span> <span class="p">:</span>
				<span class="n">DictName</span> <span class="o">=</span> <span class="n">DictRef</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">DB_Cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SQLCMDs</span><span class="p">[</span><span class="s">&#39;SelectDictID&#39;</span><span class="p">],(</span><span class="n">DictRef</span><span class="p">,))</span>
				<span class="n">dict_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">DB_Cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
			<span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">DictRef</span><span class="p">,</span><span class="nb">int</span><span class="p">)</span> <span class="p">:</span>
				<span class="n">dict_id</span> <span class="o">=</span> <span class="n">DictRef</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">DB_Cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SQLCMDs</span><span class="p">[</span><span class="s">&#39;SelectDictTable&#39;</span><span class="p">],(</span><span class="n">DictRef</span><span class="p">,))</span>
				<span class="n">DictName</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">DB_Cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
			<span class="k">else</span> <span class="p">:</span>
				<span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&quot;DictName must be str or int&quot;</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">DB_Cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SQLCMDs</span><span class="p">[</span><span class="s">&#39;WordListMax&#39;</span><span class="p">])</span>
			<span class="n">NextKey</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">DB_Cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
			<span class="k">if</span> <span class="n">NextKey</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="p">:</span>
				<span class="n">NextKey</span> <span class="o">+=</span> <span class="mi">1</span>
			<span class="k">else</span> <span class="p">:</span>
				<span class="n">NextKey</span> <span class="o">=</span> <span class="mi">0</span>
			<span class="n">WordListName</span> <span class="o">=</span> <span class="s">&quot;wordlist</span><span class="si">%d</span><span class="s">&quot;</span><span class="o">%</span><span class="n">NextKey</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">DB_Cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SQLCMDs</span><span class="p">[</span><span class="s">&#39;CreateWordList&#39;</span><span class="p">]</span><span class="o">%</span><span class="p">(</span><span class="n">WordListName</span><span class="p">,</span><span class="n">DictName</span><span class="p">))</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">DB_Cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SQLCMDs</span><span class="p">[</span><span class="s">&#39;InsertWordList&#39;</span><span class="p">],(</span><span class="n">NextKey</span><span class="p">,</span><span class="n">dict_id</span><span class="p">,</span><span class="n">WordListName</span><span class="p">,</span><span class="n">readable_name</span><span class="p">))</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">DB_Connect</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
		<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">detail</span> <span class="p">:</span>
			<span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;Failed to create a new word list table: </span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="n">detail</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">NextKey</span>
</div>
<div class="viewcode-block" id="EmailSamplesDB.WriteWords"><a class="viewcode-back" href="../apiref.html#EmailSamplesDB.EmailSamplesDB.WriteWords">[docs]</a>	<span class="k">def</span> <span class="nf">WriteWords</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">WordListRef</span><span class="p">,</span><span class="n">FileName</span><span class="p">)</span> <span class="p">:</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Save a word list from the database out to a text file.</span>

<span class="sd">		WordListRef - a reference to the word list table to save</span>
<span class="sd">		FileName - the name (full path) of the file to save</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">try</span> <span class="p">:</span>
			<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">WordListRef</span><span class="p">,</span><span class="nb">str</span><span class="p">)</span> <span class="p">:</span>
				<span class="n">ListName</span> <span class="o">=</span> <span class="n">WordListRef</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">DB_Cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SQLCMDs</span><span class="p">[</span><span class="s">&#39;SelectWordListID&#39;</span><span class="p">],(</span><span class="n">WordListRef</span><span class="p">,))</span>
				<span class="n">list_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">DB_Cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
			<span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">WordListRef</span><span class="p">,</span><span class="nb">int</span><span class="p">)</span> <span class="p">:</span>
				<span class="n">list_id</span> <span class="o">=</span> <span class="n">WordListRef</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">DB_Cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SQLCMDs</span><span class="p">[</span><span class="s">&#39;SelectWordList&#39;</span><span class="p">],(</span><span class="n">WordListRef</span><span class="p">,))</span>
				<span class="n">ListName</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">DB_Cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
			<span class="k">else</span> <span class="p">:</span>
				<span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&quot;ListName must be str or int&quot;</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">DB_Cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SQLCMDs</span><span class="p">[</span><span class="s">&#39;SelectDictRef&#39;</span><span class="p">],(</span><span class="n">list_id</span><span class="p">,))</span>
			<span class="n">DictRef</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">DB_Cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">DB_Cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SQLCMDs</span><span class="p">[</span><span class="s">&#39;SelectDictTable&#39;</span><span class="p">],(</span><span class="n">DictRef</span><span class="p">,))</span>
			<span class="n">DictName</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">DB_Cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">DB_Cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SQLCMDs</span><span class="p">[</span><span class="s">&#39;SelectFeatures&#39;</span><span class="p">]</span><span class="o">%</span><span class="p">(</span><span class="n">DictName</span><span class="p">,</span><span class="n">ListName</span><span class="p">))</span>
			<span class="n">WordList</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">DB_Cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
		<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">detail</span> <span class="p">:</span>
			<span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;Failed to grab dictionary words for writing to file.&quot;</span><span class="p">)</span>

		<span class="k">try</span> <span class="p">:</span>
			<span class="n">fhan</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">FileName</span><span class="p">,</span><span class="s">&#39;w&#39;</span><span class="p">)</span>
			<span class="k">for</span> <span class="n">Word</span> <span class="ow">in</span> <span class="n">WordList</span> <span class="p">:</span>
				<span class="n">fhan</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">Word</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
			<span class="n">fhan</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
		<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">detail</span> <span class="p">:</span>
			<span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;Failed to write the file </span><span class="si">%s</span><span class="s">: </span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">FileName</span><span class="p">,</span><span class="n">detail</span><span class="p">))</span>
		<span class="k">return</span>
	</div>
<div class="viewcode-block" id="EmailSamplesDB.LoadWords"><a class="viewcode-back" href="../apiref.html#EmailSamplesDB.EmailSamplesDB.LoadWords">[docs]</a>	<span class="k">def</span> <span class="nf">LoadWords</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">FileName</span><span class="p">)</span> <span class="p">:</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Load a list of words from a plain text file. Each word should be on its own line. Then</span>
<span class="sd">		create a dictionary table and a word list table in the database using these words.</span>

<span class="sd">		FileName - the name (full path) of the file to load</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">try</span> <span class="p">:</span>
			<span class="n">fhan</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">FileName</span><span class="p">,</span><span class="s">&#39;r&#39;</span><span class="p">)</span>
			<span class="n">Words</span> <span class="o">=</span> <span class="n">fhan</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
			<span class="n">fhan</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
		<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">detail</span> <span class="p">:</span>
			<span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;Failed to read file </span><span class="si">%s</span><span class="s">: </span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">FileName</span><span class="p">,</span><span class="n">detail</span><span class="p">))</span>
		<span class="k">try</span> <span class="p">:</span>
			<span class="n">WordList</span> <span class="o">=</span> <span class="n">Words</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
			<span class="n">WordList</span> <span class="o">=</span> <span class="nb">filter</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span><span class="n">WordList</span><span class="p">)</span>
			<span class="n">WordList</span> <span class="o">=</span> <span class="p">[(</span><span class="n">Word</span><span class="p">,)</span> <span class="k">for</span> <span class="n">Word</span> <span class="ow">in</span> <span class="n">WordList</span><span class="p">]</span>
			<span class="n">DictRef</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">CreateDict</span><span class="p">(</span><span class="n">FileName</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">DB_Cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SQLCMDs</span><span class="p">[</span><span class="s">&#39;SelectDictTable&#39;</span><span class="p">],(</span><span class="n">DictRef</span><span class="p">,))</span>
			<span class="n">DictName</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">DB_Cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">DB_Cursor</span><span class="o">.</span><span class="n">executemany</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SQLCMDs</span><span class="p">[</span><span class="s">&#39;InsertAllWordsToDict&#39;</span><span class="p">]</span><span class="o">%</span><span class="n">DictName</span><span class="p">,</span><span class="n">WordList</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">DB_Connect</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
		<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">detail</span> <span class="p">:</span>
			<span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;Failed to add words to the new dictionary: </span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="n">detail</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">DB_Connect</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
		<span class="k">return</span> <span class="n">DictRef</span>
</div>
<div class="viewcode-block" id="EmailSamplesDB.UpdateDict"><a class="viewcode-back" href="../apiref.html#EmailSamplesDB.EmailSamplesDB.UpdateDict">[docs]</a>	<span class="k">def</span> <span class="nf">UpdateDict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">DictRef</span><span class="p">,</span><span class="n">sqlcmdname</span><span class="p">)</span> <span class="p">:</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Process samples in the training set to update a dictionary with words and their frequency of</span>
<span class="sd">		occurance.</span>

<span class="sd">		DictRef -</span>
<span class="sd">			a reference to the dictionary table in the database from which the words in this list are</span>
<span class="sd">			taken</span>
<span class="sd">		sqlcmdname -</span>
<span class="sd">			if calls to AddToDB() and UpdateDict() are interleaved, it is up to the SQL query used to</span>
<span class="sd">			make sure that an email sample is not double counted in the dictionary histogram. This</span>
<span class="sd">			parameter is a key to the SQLCMD dictionary so the user can update the SQL query used.</span>
<span class="sd">			Samples used to create a dictionary are tracked in a separate table in the database.</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="c"># TODO: Rewrite this function to avoid using a temporary database by using an SQL query</span>
		<span class="c">#       with LIMIT and OFFSET.  Test which method is faster.</span>
		<span class="k">try</span> <span class="p">:</span>
			<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">DictRef</span><span class="p">,</span><span class="nb">str</span><span class="p">)</span> <span class="p">:</span>
				<span class="n">DictName</span> <span class="o">=</span> <span class="n">DictRef</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">DB_Cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SQLCMDs</span><span class="p">[</span><span class="s">&#39;SelectDictID&#39;</span><span class="p">],(</span><span class="n">DictRef</span><span class="p">,))</span>
				<span class="n">dict_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">DB_Cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
			<span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">DictRef</span><span class="p">,</span><span class="nb">int</span><span class="p">)</span> <span class="p">:</span>
				<span class="n">dict_id</span> <span class="o">=</span> <span class="n">DictRef</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">DB_Cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SQLCMDs</span><span class="p">[</span><span class="s">&#39;SelectDictTable&#39;</span><span class="p">],(</span><span class="n">DictRef</span><span class="p">,))</span>
				<span class="n">DictName</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">DB_Cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
			<span class="k">else</span> <span class="p">:</span>
				<span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&quot;DictName must be str or int&quot;</span><span class="p">)</span>

			<span class="c">#pdb.set_trace()</span>
			<span class="c"># Setup temporary database</span>
			<span class="n">tmpdb</span> <span class="o">=</span> <span class="n">TempDB</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;TempDBCMDs&#39;</span><span class="p">])</span>
			<span class="c"># Connect and create temporary tables</span>
			<span class="n">tmpdb</span><span class="o">.</span><span class="n">ConnectDB</span><span class="p">()</span>
			<span class="n">tmpdb</span><span class="o">.</span><span class="n">RunCommand</span><span class="p">(</span><span class="n">tmpdb</span><span class="o">.</span><span class="n">SQLCMDs</span><span class="p">[</span><span class="s">&#39;CreateDictTable&#39;</span><span class="p">]</span><span class="o">%</span><span class="n">DictName</span><span class="p">)</span>
			<span class="n">tmpdb</span><span class="o">.</span><span class="n">RunCommand</span><span class="p">(</span><span class="n">tmpdb</span><span class="o">.</span><span class="n">SQLCMDs</span><span class="p">[</span><span class="s">&#39;CreateDictBuildTable&#39;</span><span class="p">])</span>
			<span class="n">tmpdb</span><span class="o">.</span><span class="n">DisconnectDB</span><span class="p">()</span>
			<span class="c"># Attach temporary database</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">DB_Cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SQLCMDs</span><span class="p">[</span><span class="s">&#39;AttachDB&#39;</span><span class="p">],(</span><span class="n">tmpdb</span><span class="o">.</span><span class="n">DBpath</span><span class="p">,</span><span class="s">&quot;tmp&quot;</span><span class="p">))</span>
			<span class="c"># Copy dictionary and dictbuild to temporary database</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">DB_Cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SQLCMDs</span><span class="p">[</span><span class="s">&#39;CopyTable&#39;</span><span class="p">]</span><span class="o">%</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s">&quot;tmp&quot;</span><span class="p">,</span><span class="n">DictName</span><span class="p">]),</span><span class="n">DictName</span><span class="p">))</span>
			<span class="n">dictbuild</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SQLCMDs</span><span class="p">[</span><span class="s">&#39;DictBuildTableName&#39;</span><span class="p">]</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">DB_Cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SQLCMDs</span><span class="p">[</span><span class="s">&#39;CopyTable&#39;</span><span class="p">]</span><span class="o">%</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s">&quot;tmp&quot;</span><span class="p">,</span><span class="n">dictbuild</span><span class="p">]),</span><span class="n">dictbuild</span><span class="p">))</span>
			<span class="c"># Detach temporary database</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">DB_Cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SQLCMDs</span><span class="p">[</span><span class="s">&#39;DetachDB&#39;</span><span class="p">],(</span><span class="s">&quot;tmp&quot;</span><span class="p">,))</span>
			
			<span class="c"># Connect to temporary database</span>
			<span class="n">tmpdb</span><span class="o">.</span><span class="n">ConnectDB</span><span class="p">()</span>
			<span class="c"># Loop over samples in persistent db and update tables in tempdb</span>
			<span class="n">CommitCount</span> <span class="o">=</span> <span class="mi">0</span>
			<span class="k">for</span> <span class="n">sample_id</span><span class="p">,</span><span class="n">SampleBody</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">DB_Cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SQLCMDs</span><span class="p">[</span><span class="n">sqlcmdname</span><span class="p">],(</span><span class="n">dict_id</span><span class="p">,))</span> <span class="p">:</span>
				<span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Working on: </span><span class="si">%d</span><span class="s">&quot;</span><span class="o">%</span><span class="n">sample_id</span><span class="p">)</span>
				<span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Inserting row to dictionary build table&quot;</span><span class="p">)</span>
				<span class="n">tmpdb</span><span class="o">.</span><span class="n">RunCommand</span><span class="p">(</span><span class="n">tmpdb</span><span class="o">.</span><span class="n">SQLCMDs</span><span class="p">[</span><span class="s">&#39;InsertUsed&#39;</span><span class="p">],(</span><span class="n">sample_id</span><span class="p">,</span><span class="n">dict_id</span><span class="p">))</span>
				<span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Counting email body words&quot;</span><span class="p">)</span>
				<span class="n">SampleWordCounts</span> <span class="o">=</span> <span class="n">FeatureVecGen</span><span class="o">.</span><span class="n">ParetoWords</span><span class="p">(</span><span class="n">SampleBody</span><span class="p">)</span>
				<span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Looping over the words&quot;</span><span class="p">)</span>
				<span class="k">for</span> <span class="n">Word</span> <span class="ow">in</span> <span class="n">SampleWordCounts</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="p">:</span>
					<span class="n">tmpdb</span><span class="o">.</span><span class="n">RunCommand</span><span class="p">(</span><span class="n">tmpdb</span><span class="o">.</span><span class="n">SQLCMDs</span><span class="p">[</span><span class="s">&#39;RetrieveWordCount&#39;</span><span class="p">]</span><span class="o">%</span><span class="n">DictName</span><span class="p">,(</span><span class="n">Word</span><span class="p">,))</span>
					<span class="n">OldCount</span> <span class="o">=</span> <span class="n">tmpdb</span><span class="o">.</span><span class="n">DB_Cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
					<span class="k">if</span> <span class="n">OldCount</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="p">:</span>
						<span class="n">SampleWordCounts</span><span class="p">[</span><span class="n">Word</span><span class="p">]</span> <span class="o">=</span> <span class="n">SampleWordCounts</span><span class="p">[</span><span class="n">Word</span><span class="p">]</span> <span class="o">+</span> <span class="n">OldCount</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
				<span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Updating the word counts&quot;</span><span class="p">)</span>
				<span class="k">if</span> <span class="n">CommitCount</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;CommitFreq&#39;</span><span class="p">]</span> <span class="p">:</span>
					<span class="n">CommitCount</span> <span class="o">+=</span> <span class="mi">1</span>
					<span class="n">tmpdb</span><span class="o">.</span><span class="n">RunCommands</span><span class="p">(</span><span class="n">tmpdb</span><span class="o">.</span><span class="n">SQLCMDs</span><span class="p">[</span><span class="s">&#39;UpdateWordCount&#39;</span><span class="p">]</span><span class="o">%</span><span class="n">DictName</span><span class="p">,</span><span class="n">SampleWordCounts</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span><span class="bp">False</span><span class="p">)</span>
				<span class="k">else</span> <span class="p">:</span>
					<span class="n">tmpdb</span><span class="o">.</span><span class="n">RunCommands</span><span class="p">(</span><span class="n">tmpdb</span><span class="o">.</span><span class="n">SQLCMDs</span><span class="p">[</span><span class="s">&#39;UpdateWordCount&#39;</span><span class="p">]</span><span class="o">%</span><span class="n">DictName</span><span class="p">,</span><span class="n">SampleWordCounts</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span><span class="bp">True</span><span class="p">)</span>
					<span class="n">CommitCount</span> <span class="o">=</span> <span class="mi">0</span>
			<span class="n">tmpdb</span><span class="o">.</span><span class="n">DB_Connect</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
			<span class="n">tmpdb</span><span class="o">.</span><span class="n">DisconnectDB</span><span class="p">()</span>

			<span class="c">#pdb.set_trace()</span>
			<span class="c"># Attach tempdb</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">DB_Cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SQLCMDs</span><span class="p">[</span><span class="s">&#39;AttachDB&#39;</span><span class="p">],(</span><span class="n">tmpdb</span><span class="o">.</span><span class="n">DBpath</span><span class="p">,</span><span class="s">&quot;tmp&quot;</span><span class="p">))</span>
			<span class="c"># Copy tables from tempdb</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">DB_Cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SQLCMDs</span><span class="p">[</span><span class="s">&#39;TransferUsed&#39;</span><span class="p">]</span><span class="o">%</span><span class="s">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s">&quot;tmp&quot;</span><span class="p">,</span><span class="n">dictbuild</span><span class="p">]))</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">DB_Cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SQLCMDs</span><span class="p">[</span><span class="s">&#39;TransferDict&#39;</span><span class="p">]</span><span class="o">%</span><span class="p">(</span><span class="n">DictName</span><span class="p">,</span><span class="s">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s">&quot;tmp&quot;</span><span class="p">,</span><span class="n">DictName</span><span class="p">])))</span>
			<span class="c"># Detach and delete tempdb</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">DB_Cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SQLCMDs</span><span class="p">[</span><span class="s">&#39;DetachDB&#39;</span><span class="p">],(</span><span class="s">&quot;tmp&quot;</span><span class="p">,))</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">DB_Connect</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
			<span class="k">del</span> <span class="n">tmpdb</span>
		<span class="k">except</span> <span class="ne">TypeError</span> <span class="k">as</span> <span class="n">detail</span> <span class="p">:</span>
			<span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">detail</span><span class="p">)</span>
		<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">detail</span> <span class="p">:</span>
			<span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;Failed to update dictionary </span><span class="si">%s</span><span class="s">: </span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">DictName</span><span class="p">,</span><span class="n">detail</span><span class="p">))</span>
			<span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;Sample id: </span><span class="si">%d</span><span class="se">\n</span><span class="s">Dictionary id: </span><span class="si">%d</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">sample_id</span><span class="p">,</span><span class="n">dict_id</span><span class="p">))</span>
			<span class="n">tb</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
			<span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">tb</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">DB_Connect</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
		<span class="k">return</span>
</div>
<div class="viewcode-block" id="EmailSamplesDB.UpdateWordList"><a class="viewcode-back" href="../apiref.html#EmailSamplesDB.EmailSamplesDB.UpdateWordList">[docs]</a>	<span class="k">def</span> <span class="nf">UpdateWordList</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">WordListRef</span><span class="p">,</span><span class="n">WordFilter</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span> <span class="p">:</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Update a word list whenever a dictionary has been changed. Word lists are connected to specific</span>
<span class="sd">		dictionaries internally in the database, so it is not necessary to provide a dictionary reference.</span>

<span class="sd">		WordListRef -</span>
<span class="sd">			a reference to the word list table to save</span>
<span class="sd">		WordFilter -</span>
<span class="sd">			allows the user to control whether words in the dictionary should be excluded from</span>
<span class="sd">			the list based on parameters provided as class attributes (True) or all words in the</span>
<span class="sd">			dictionary should be added to the list (False)</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">try</span> <span class="p">:</span>
			<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">WordListRef</span><span class="p">,</span><span class="nb">str</span><span class="p">)</span> <span class="p">:</span>
				<span class="n">ListName</span> <span class="o">=</span> <span class="n">WordListRef</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">DB_Cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SQLCMDs</span><span class="p">[</span><span class="s">&#39;SelectWordListID&#39;</span><span class="p">],(</span><span class="n">WordListRef</span><span class="p">,))</span>
				<span class="n">list_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">DB_Cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
			<span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">WordListRef</span><span class="p">,</span><span class="nb">int</span><span class="p">)</span> <span class="p">:</span>
				<span class="n">list_id</span> <span class="o">=</span> <span class="n">WordListRef</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">DB_Cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SQLCMDs</span><span class="p">[</span><span class="s">&#39;SelectWordList&#39;</span><span class="p">],(</span><span class="n">WordListRef</span><span class="p">,))</span>
				<span class="n">ListName</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">DB_Cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
			<span class="k">else</span> <span class="p">:</span>
				<span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&quot;WordListRef must be str or int&quot;</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">DB_Cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SQLCMDs</span><span class="p">[</span><span class="s">&#39;SelectDictRef&#39;</span><span class="p">],(</span><span class="n">list_id</span><span class="p">,))</span>
			<span class="n">DictRef</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">DB_Cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">DB_Cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SQLCMDs</span><span class="p">[</span><span class="s">&#39;SelectDictTable&#39;</span><span class="p">],(</span><span class="n">DictRef</span><span class="p">,))</span>
			<span class="n">DictName</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">DB_Cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
			<span class="k">if</span> <span class="n">WordFilter</span> <span class="o">==</span> <span class="bp">True</span> <span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">DB_Cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SQLCMDs</span><span class="p">[</span><span class="s">&#39;TotalWordCount&#39;</span><span class="p">]</span><span class="o">%</span><span class="n">DictName</span><span class="p">)</span>
				<span class="n">TotalCount</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">DB_Cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
				<span class="n">CountMax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;MaxCountFrac&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">TotalCount</span>
				<span class="n">CountMin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;MinCountFrac&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">TotalCount</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">DB_Cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SQLCMDs</span><span class="p">[</span><span class="s">&#39;InsertWords&#39;</span><span class="p">]</span><span class="o">%</span><span class="p">(</span><span class="n">ListName</span><span class="p">,</span><span class="n">DictName</span><span class="p">),(</span><span class="n">CountMin</span><span class="p">,</span><span class="n">CountMax</span><span class="p">))</span>
			<span class="k">else</span> <span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">DB_Cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SQLCMDs</span><span class="p">[</span><span class="s">&#39;InsertAllWords&#39;</span><span class="p">]</span><span class="o">%</span><span class="p">(</span><span class="n">ListName</span><span class="p">,</span><span class="n">DictName</span><span class="p">))</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">DB_Connect</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
		<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">detail</span> <span class="p">:</span>
			<span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;Failed to update word list </span><span class="si">%s</span><span class="s">: </span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">ListName</span><span class="p">,</span><span class="n">detail</span><span class="p">))</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">DB_Connect</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="EmailSamplesDB.MakeFeatureVecs"><a class="viewcode-back" href="../apiref.html#EmailSamplesDB.EmailSamplesDB.MakeFeatureVecs">[docs]</a>	<span class="k">def</span> <span class="nf">MakeFeatureVecs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">WordListRef</span><span class="p">,</span><span class="n">sqlcmdname</span><span class="p">)</span> <span class="p">:</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Create feature vectors against a given word list. Uses a FeatureVecGen object as an engine for</span>
<span class="sd">		creating the feature vector given an email sample body.</span>
<span class="sd">		</span>
<span class="sd">		WordListRef -</span>
<span class="sd">			a reference to the word list table to save</span>
<span class="sd">		sqlcmdname -</span>
<span class="sd">			this parameter is a key to the SQLCMD dictionary so the user can update the SQL query used</span>
<span class="sd">			to select samples for which to create feature vectors. Typical usage would be to SELECT</span>
<span class="sd">			all the available samples in the database for all classes.</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">try</span> <span class="p">:</span>
			<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">WordListRef</span><span class="p">,</span><span class="nb">str</span><span class="p">)</span> <span class="p">:</span>
				<span class="n">ListName</span> <span class="o">=</span> <span class="n">WordListRef</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">DB_Cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SQLCMDs</span><span class="p">[</span><span class="s">&#39;SelectWordListID&#39;</span><span class="p">],(</span><span class="n">WordListRef</span><span class="p">,))</span>
				<span class="n">list_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">DB_Cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
			<span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">WordListRef</span><span class="p">,</span><span class="nb">int</span><span class="p">)</span> <span class="p">:</span>
				<span class="n">list_id</span> <span class="o">=</span> <span class="n">WordListRef</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">DB_Cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SQLCMDs</span><span class="p">[</span><span class="s">&#39;SelectWordList&#39;</span><span class="p">],(</span><span class="n">WordListRef</span><span class="p">,))</span>
				<span class="n">ListName</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">DB_Cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
			<span class="k">else</span> <span class="p">:</span>
				<span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&quot;WordListRef must be str or int&quot;</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">DB_Cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SQLCMDs</span><span class="p">[</span><span class="s">&#39;SelectDictRef&#39;</span><span class="p">],(</span><span class="n">list_id</span><span class="p">,))</span>
			<span class="n">DictRef</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">DB_Cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">DB_Cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SQLCMDs</span><span class="p">[</span><span class="s">&#39;SelectDictTable&#39;</span><span class="p">],(</span><span class="n">DictRef</span><span class="p">,))</span>
			<span class="n">DictName</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">DB_Cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>

			<span class="c">#Get the feature vector word list</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">DB_Cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SQLCMDs</span><span class="p">[</span><span class="s">&#39;SelectFeatures&#39;</span><span class="p">]</span><span class="o">%</span><span class="p">(</span><span class="n">DictName</span><span class="p">,</span><span class="n">ListName</span><span class="p">))</span>
			<span class="n">FeatureWords</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">DB_Cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
			<span class="n">FeatureWords</span> <span class="o">=</span> <span class="p">[</span><span class="n">word</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">FeatureWords</span><span class="p">]</span>
			<span class="c">#Init FeatureVecGen object</span>
			<span class="n">FeatureMaker</span> <span class="o">=</span> <span class="n">FeatureVecGen</span><span class="p">(</span><span class="n">FeatureWords</span><span class="p">)</span>
			<span class="c"># Setup temporary database</span>
			<span class="n">tmpdb</span> <span class="o">=</span> <span class="n">TempDB</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;TempDBCMDs&#39;</span><span class="p">])</span>
			<span class="c"># Connect and create temporary tables</span>
			<span class="n">tmpdb</span><span class="o">.</span><span class="n">ConnectDB</span><span class="p">()</span>
			<span class="n">tmpdb</span><span class="o">.</span><span class="n">RunCommand</span><span class="p">(</span><span class="n">tmpdb</span><span class="o">.</span><span class="n">SQLCMDs</span><span class="p">[</span><span class="s">&#39;CreateFeatureTable&#39;</span><span class="p">])</span>
			<span class="n">tmpdb</span><span class="o">.</span><span class="n">DisconnectDB</span><span class="p">()</span>
			<span class="c"># Attach temporary database</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">DB_Cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SQLCMDs</span><span class="p">[</span><span class="s">&#39;AttachDB&#39;</span><span class="p">],(</span><span class="n">tmpdb</span><span class="o">.</span><span class="n">DBpath</span><span class="p">,</span><span class="s">&quot;tmp&quot;</span><span class="p">))</span>
			<span class="c"># Copy dictionary and dictbuild to temporary database</span>
			<span class="n">featuretab</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SQLCMDs</span><span class="p">[</span><span class="s">&#39;FeaturesTableName&#39;</span><span class="p">]</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">DB_Cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SQLCMDs</span><span class="p">[</span><span class="s">&#39;CopyTable&#39;</span><span class="p">]</span><span class="o">%</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s">&quot;tmp&quot;</span><span class="p">,</span><span class="n">featuretab</span><span class="p">]),</span><span class="n">featuretab</span><span class="p">))</span>
			<span class="c"># Detach temporary database</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">DB_Cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SQLCMDs</span><span class="p">[</span><span class="s">&#39;DetachDB&#39;</span><span class="p">],(</span><span class="s">&quot;tmp&quot;</span><span class="p">,))</span>
			
			<span class="c"># Connect to temporary database</span>
			<span class="n">tmpdb</span><span class="o">.</span><span class="n">ConnectDB</span><span class="p">()</span>
			<span class="c"># Loop over samples in persistent db and update tables in tempdb</span>
			<span class="n">CommitCount</span> <span class="o">=</span> <span class="mi">0</span>
			<span class="k">for</span> <span class="n">sample_id</span><span class="p">,</span><span class="n">SampleBody</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">DB_Cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SQLCMDs</span><span class="p">[</span><span class="n">sqlcmdname</span><span class="p">])</span> <span class="p">:</span>
				<span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Working on: </span><span class="si">%d</span><span class="s">&quot;</span><span class="o">%</span><span class="n">sample_id</span><span class="p">)</span>
				<span class="n">featurevec</span> <span class="o">=</span> <span class="n">FeatureMaker</span><span class="o">.</span><span class="n">MakeVec</span><span class="p">(</span><span class="n">SampleBody</span><span class="p">)</span>
				<span class="n">featureserial</span> <span class="o">=</span> <span class="nb">buffer</span><span class="p">(</span><span class="n">cPickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">featurevec</span><span class="p">))</span>
				<span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Inserting row to feature table&quot;</span><span class="p">)</span>
				<span class="k">if</span> <span class="n">CommitCount</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;CommitFreq&#39;</span><span class="p">]</span> <span class="p">:</span>
					<span class="n">CommitCount</span> <span class="o">+=</span> <span class="mi">1</span>
					<span class="n">tmpdb</span><span class="o">.</span><span class="n">RunCommand</span><span class="p">(</span><span class="n">tmpdb</span><span class="o">.</span><span class="n">SQLCMDs</span><span class="p">[</span><span class="s">&#39;InsertFeature&#39;</span><span class="p">],(</span><span class="n">sample_id</span><span class="p">,</span><span class="n">list_id</span><span class="p">,</span><span class="n">featureserial</span><span class="p">),</span><span class="bp">False</span><span class="p">)</span>
				<span class="k">else</span> <span class="p">:</span>
					<span class="n">tmpdb</span><span class="o">.</span><span class="n">RunCommand</span><span class="p">(</span><span class="n">tmpdb</span><span class="o">.</span><span class="n">SQLCMDs</span><span class="p">[</span><span class="s">&#39;InsertFeature&#39;</span><span class="p">],(</span><span class="n">sample_id</span><span class="p">,</span><span class="n">list_id</span><span class="p">,</span><span class="n">featureserial</span><span class="p">),</span><span class="bp">True</span><span class="p">)</span>
					<span class="n">CommitCount</span> <span class="o">=</span> <span class="mi">0</span>
			<span class="n">tmpdb</span><span class="o">.</span><span class="n">DB_Connect</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
			<span class="n">tmpdb</span><span class="o">.</span><span class="n">DisconnectDB</span><span class="p">()</span>

			<span class="c">#pdb.set_trace()</span>
			<span class="c"># Attach tempdb</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">DB_Cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SQLCMDs</span><span class="p">[</span><span class="s">&#39;AttachDB&#39;</span><span class="p">],(</span><span class="n">tmpdb</span><span class="o">.</span><span class="n">DBpath</span><span class="p">,</span><span class="s">&quot;tmp&quot;</span><span class="p">))</span>
			<span class="c"># Copy tables from tempdb</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">DB_Cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SQLCMDs</span><span class="p">[</span><span class="s">&#39;TransferFeatures&#39;</span><span class="p">]</span><span class="o">%</span><span class="s">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s">&quot;tmp&quot;</span><span class="p">,</span><span class="n">featuretab</span><span class="p">]))</span>
			<span class="c"># Detach and delete tempdb</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">DB_Cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SQLCMDs</span><span class="p">[</span><span class="s">&#39;DetachDB&#39;</span><span class="p">],(</span><span class="s">&quot;tmp&quot;</span><span class="p">,))</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">DB_Connect</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
			<span class="k">del</span> <span class="n">tmpdb</span>
		<span class="k">except</span> <span class="ne">TypeError</span> <span class="k">as</span> <span class="n">detail</span> <span class="p">:</span>
			<span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">detail</span><span class="p">)</span>
		<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">detail</span> <span class="p">:</span>
			<span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;Failed to create feature vectors: </span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="n">detail</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">DB_Connect</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
		<span class="k">return</span>
</div>
<div class="viewcode-block" id="EmailSamplesDB.GetSampleDistribution"><a class="viewcode-back" href="../apiref.html#EmailSamplesDB.EmailSamplesDB.GetSampleDistribution">[docs]</a>	<span class="k">def</span> <span class="nf">GetSampleDistribution</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="p">:</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Return the fraction of samples in the database assigned to each set (training,cross validation,test)</span>

<span class="sd">		Return values:</span>
<span class="sd">			SetIDs - a list of the primary keys assigned to the sets in the database</span>
<span class="sd">			SetDistr - a list of the fractions of samples assigned to each set</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">try</span> <span class="p">:</span>
			<span class="n">SetList</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SQLCMDs</span><span class="p">[</span><span class="s">&#39;SetList&#39;</span><span class="p">]</span>
			<span class="n">SetIDs</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">SetList</span><span class="p">)</span>
			<span class="n">SetDistr</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">SetList</span><span class="p">)</span>
			<span class="k">for</span> <span class="n">ii</span><span class="p">,</span><span class="n">setname</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">SetList</span><span class="p">)</span> <span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">DB_Cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SQLCMDs</span><span class="p">[</span><span class="s">&#39;SelectSetID&#39;</span><span class="p">],(</span><span class="n">setname</span><span class="p">,))</span>
				<span class="n">SetIDs</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">DB_Cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">DB_Cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SQLCMDs</span><span class="p">[</span><span class="s">&#39;SampleSetCount&#39;</span><span class="p">],(</span><span class="n">SetIDs</span><span class="p">[</span><span class="n">ii</span><span class="p">],))</span>
				<span class="n">SetDistr</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">DB_Cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
		<span class="k">except</span> <span class="p">:</span>
			<span class="n">logging</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s">&quot;Failed to retrieve sample set distribution&quot;</span><span class="p">)</span>
			<span class="nb">exit</span><span class="p">()</span>
		<span class="k">return</span> <span class="n">SetIDs</span><span class="p">,</span><span class="n">SetDistr</span>
</div>
<div class="viewcode-block" id="EmailSamplesDB.GetSampleCount"><a class="viewcode-back" href="../apiref.html#EmailSamplesDB.EmailSamplesDB.GetSampleCount">[docs]</a>	<span class="k">def</span> <span class="nf">GetSampleCount</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="p">:</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Return the number of samples in the database</span>

<span class="sd">		Return values:</span>
<span class="sd">			CurSampleCount - integer number of samples in the database</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">try</span> <span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">DB_Cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SQLCMDs</span><span class="p">[</span><span class="s">&#39;SampleCount&#39;</span><span class="p">])</span>
			<span class="n">CurSampleCount</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">DB_Cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
		<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">detail</span><span class="p">:</span>
			<span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;Failed to get count of samples in database: </span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="n">detail</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">CurSampleCount</span>
</div>
<div class="viewcode-block" id="EmailSamplesDB.GetTrainSampleCount"><a class="viewcode-back" href="../apiref.html#EmailSamplesDB.EmailSamplesDB.GetTrainSampleCount">[docs]</a>	<span class="k">def</span> <span class="nf">GetTrainSampleCount</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="p">:</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Return the number of samples in the training set</span>

<span class="sd">		Return values:</span>
<span class="sd">			CurSampleCount - integer number of samples in the training set</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">try</span> <span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">DB_Cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SQLCMDs</span><span class="p">[</span><span class="s">&#39;SampleSetCount&#39;</span><span class="p">],(</span><span class="mi">0</span><span class="p">,))</span>
			<span class="n">CurSampleCount</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">DB_Cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
		<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">detail</span><span class="p">:</span>
			<span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;Failed to get count of training samples in database: </span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="n">detail</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">CurSampleCount</span>
</div>
<div class="viewcode-block" id="EmailSamplesDB.GetAvailableWordLists"><a class="viewcode-back" href="../apiref.html#EmailSamplesDB.EmailSamplesDB.GetAvailableWordLists">[docs]</a>	<span class="k">def</span> <span class="nf">GetAvailableWordLists</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="p">:</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Return the word lists available in the database</span>

<span class="sd">		Return values:</span>
<span class="sd">			WordLists - a list of tuples with the available wordlists in the database where the SQL query</span>
<span class="sd">			used controls the order of items in the tuple</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">try</span> <span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">DB_Cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SQLCMDs</span><span class="p">[</span><span class="s">&#39;SelectWordLists&#39;</span><span class="p">])</span>
			<span class="n">WordLists</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">DB_Cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
		<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">detail</span> <span class="p">:</span>
			<span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;Failed to return word lists: </span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="n">detail</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">WordLists</span>
</div>
<div class="viewcode-block" id="EmailSamplesDB.GetXY"><a class="viewcode-back" href="../apiref.html#EmailSamplesDB.EmailSamplesDB.GetXY">[docs]</a>	<span class="k">def</span> <span class="nf">GetXY</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">WordListRef</span><span class="p">,</span><span class="n">SetID</span><span class="p">,</span><span class="n">Limit</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">Offset</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="p">:</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Return feature vectors and their classes. The order is controlled by the SQL query used, and there</span>
<span class="sd">		is a value saved along with each sample to help randomize the mixture of classes returned.</span>

<span class="sd">		WordListRef -</span>
<span class="sd">			a reference to the word list table to save</span>
<span class="sd">		SetID -</span>
<span class="sd">			the primary key assigned to the set in the database for the requested feature vectors</span>
<span class="sd">		Limit -</span>
<span class="sd">			optional positive integer parameter to limit the number of feature vectors returned</span>
<span class="sd">		Offset -</span>
<span class="sd">			optional non-negative integer parameter to skip some number of feature vectors in the</span>
<span class="sd">			database. If Limit is None then Offset is forced to be 0 regardless of the value provided.</span>

<span class="sd">		Return values:</span>
<span class="sd">			X - a list of the requested feature vectors</span>
<span class="sd">			Y - a list of the classes associated with the returned feature vectors</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">try</span> <span class="p">:</span>
			<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">WordListRef</span><span class="p">,</span><span class="nb">str</span><span class="p">)</span> <span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">DB_Cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SQLCMDs</span><span class="p">[</span><span class="s">&#39;SelectWordListID&#39;</span><span class="p">],(</span><span class="n">WordListRef</span><span class="p">,))</span>
				<span class="n">list_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">DB_Cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
			<span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">WordListRef</span><span class="p">,</span><span class="nb">int</span><span class="p">)</span> <span class="p">:</span>
				<span class="n">list_id</span> <span class="o">=</span> <span class="n">WordListRef</span>
			<span class="k">else</span> <span class="p">:</span>
				<span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&quot;WordListRef must be str or int&quot;</span><span class="p">)</span>
			<span class="k">if</span> <span class="n">Limit</span> <span class="ow">is</span> <span class="bp">None</span> <span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">DB_Cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SQLCMDs</span><span class="p">[</span><span class="s">&#39;SampleCount&#39;</span><span class="p">])</span>
				<span class="n">Limit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">DB_Cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
				<span class="n">Offset</span> <span class="o">=</span> <span class="mi">0</span>
			<span class="k">assert</span> <span class="p">(</span><span class="n">Limit</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">),</span><span class="s">&quot;Limit argument must be a positive integer!&quot;</span>
			<span class="k">assert</span> <span class="p">(</span><span class="n">Offset</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">),</span><span class="s">&quot;Offset argument must be a non-negative integer!&quot;</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">DB_Cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SQLCMDs</span><span class="p">[</span><span class="s">&#39;GetXY&#39;</span><span class="p">],(</span><span class="n">list_id</span><span class="p">,</span><span class="n">SetID</span><span class="p">,</span><span class="n">Limit</span><span class="p">,</span><span class="n">Offset</span><span class="p">))</span>
			<span class="n">XYs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">DB_Cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
			<span class="n">XYs</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">XYs</span><span class="p">))</span>
			<span class="n">X</span> <span class="o">=</span> <span class="n">XYs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
			<span class="k">for</span> <span class="n">ii</span><span class="p">,</span><span class="n">featurevec</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">X</span><span class="p">)</span> <span class="p">:</span>
				<span class="n">X</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">cPickle</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">featurevec</span><span class="p">))</span>
			<span class="n">Y</span> <span class="o">=</span> <span class="n">XYs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
		<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">detail</span> <span class="p">:</span>
			<span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;Failed to get X and Y lists: </span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="n">detail</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">X</span><span class="p">,</span><span class="n">Y</span>
</div>
<div class="viewcode-block" id="EmailSamplesDB.AssignSamplesToSets"><a class="viewcode-back" href="../apiref.html#EmailSamplesDB.EmailSamplesDB.AssignSamplesToSets">[docs]</a>	<span class="k">def</span> <span class="nf">AssignSamplesToSets</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">NumNewSamples</span><span class="p">,</span><span class="n">samp_distr_targ</span><span class="p">)</span> <span class="p">:</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Create set assignments for a number of new samples to be added to the database (training, cross validation, or test)</span>

<span class="sd">		NumNewSamples -</span>
<span class="sd">			the number of new samples to add; a set assignment will be made for each new sample</span>
<span class="sd">		samp_distr_targ -</span>
<span class="sd">			a tuple containing the desired fraction of samples assigned to each set (training,cross</span>
<span class="sd">			validation,test).  New samples are distributed to optimally match this desired distribution</span>
<span class="sd">			based on the number of new samples provided and the current distribution between sets of </span>
<span class="sd">			samples already in the database. Each value in the tuple should be in the range [0,1], and</span>
<span class="sd">			the total of all values in the tuple should be 1.</span>

<span class="sd">		Return values:</span>
<span class="sd">			SetAssignmentList - a list of set assignments for each new sample; len(SetAssignmentList) == NumNewSamples</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">SetAssignmentList</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="p">(</span><span class="n">SetIDs</span><span class="p">,</span><span class="n">CurrentDistr</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">GetSampleDistribution</span><span class="p">()</span>
		<span class="n">CurSampleCount</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">GetSampleCount</span><span class="p">()</span>
		<span class="k">try</span> <span class="p">:</span>
			<span class="n">NumSets</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">CurrentDistr</span><span class="p">)</span>
			<span class="n">x0</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">NumSets</span>
			<span class="n">x0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">NumNewSamples</span>
			<span class="n">x0</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">x0</span><span class="p">)</span>
			<span class="n">constargs</span> <span class="o">=</span> <span class="p">(</span><span class="n">samp_distr_targ</span><span class="p">,</span><span class="n">NumNewSamples</span><span class="p">,</span><span class="n">CurSampleCount</span><span class="p">,</span><span class="n">CurrentDistr</span><span class="p">)</span>
			<span class="c"># boundary conditions - the new samples must be distributed to each set by fractions in the range [0,1]</span>
			<span class="n">bnds</span> <span class="o">=</span> <span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">),(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">),(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
			<span class="c"># constraints - the total of the distribution fractions must be equal to 1</span>
			<span class="n">cons</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;type&#39;</span><span class="p">:</span><span class="s">&#39;eq&#39;</span><span class="p">,</span><span class="s">&#39;fun&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">}</span>
			<span class="n">res</span> <span class="o">=</span> <span class="n">minimize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">TargetDistrObj</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">constargs</span><span class="p">,</span><span class="n">method</span><span class="o">=</span><span class="s">&#39;SLSQP&#39;</span><span class="p">,</span><span class="n">bounds</span><span class="o">=</span><span class="n">bnds</span><span class="p">,</span><span class="n">constraints</span><span class="o">=</span><span class="n">cons</span><span class="p">)</span>
			<span class="n">AddedDistr</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">NumSets</span>
			<span class="n">tot</span> <span class="o">=</span> <span class="mi">0</span>
			<span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">NumSets</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">:</span>
				<span class="n">AddedDistr</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">*</span><span class="n">NumNewSamples</span><span class="p">)</span>
				<span class="n">tot</span> <span class="o">+=</span> <span class="n">AddedDistr</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
			<span class="n">AddedDistr</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">NumNewSamples</span><span class="o">-</span><span class="n">tot</span>
			<span class="k">assert</span> <span class="n">AddedDistr</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">,</span><span class="s">&quot;Rounding problem calculating distribution of new samples into sets&quot;</span>
			<span class="k">for</span> <span class="n">ii</span><span class="p">,</span><span class="n">val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">AddedDistr</span><span class="p">)</span> <span class="p">:</span>
				<span class="c">#print val</span>
				<span class="n">SetAssignmentList</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">SetIDs</span><span class="p">[</span><span class="n">ii</span><span class="p">]]</span><span class="o">*</span><span class="nb">int</span><span class="p">(</span><span class="n">val</span><span class="p">))</span>
		<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">detail</span><span class="p">:</span>
			<span class="n">logging</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s">&quot;Failed to create set assignments: </span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="n">detail</span><span class="p">)</span>
			<span class="nb">exit</span><span class="p">()</span>
		<span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">SetAssignmentList</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">SetAssignmentList</span>
</div>
	<span class="nd">@staticmethod</span>
<div class="viewcode-block" id="EmailSamplesDB.TargetDistrObj"><a class="viewcode-back" href="../apiref.html#EmailSamplesDB.EmailSamplesDB.TargetDistrObj">[docs]</a>	<span class="k">def</span> <span class="nf">TargetDistrObj</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="n">newsamps</span><span class="p">,</span><span class="n">oldsamps</span><span class="p">,</span><span class="n">oldsetcounts</span><span class="p">)</span> <span class="p">:</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Implements the equation to optimize for calculating how to distribute a given number of new samples between sets</span>

<span class="sd">		.. math::</span>

<span class="sd">			E = \\sum_{i=1}^3 (t_{i} - f_{i})^{2}</span>

<span class="sd">		where</span>

<span class="sd">		:math:`E` is the sample distribution sum of squares error</span>

<span class="sd">		:math:`t_{i}` is the targeted fractional distribution of samples to set i</span>

<span class="sd">		:math:`f_{i}` is the resulting fractional distribution of samples from a proposal to add a number of new samples to set i</span>

<span class="sd">		and :math:`i` iterates over (training, cross validation, and test) sets</span>
<span class="sd">		</span>
<span class="sd">		t -</span>
<span class="sd">			tuple of targeted distribution fractions; each value must be in the range [0,1] and the total must = 1</span>
<span class="sd">		newsamps -</span>
<span class="sd">			the total number of new samples to add to the database (integer)</span>
<span class="sd">		oldsamps -</span>
<span class="sd">			the total number of samples already in the database (integer)</span>
<span class="sd">		oldsetcounts -</span>
<span class="sd">			tuple of the (integer) counts of samples in each set for samples already in the database</span>
<span class="sd">		newtotal -</span>
<span class="sd">			the total number of samples that will be in the database once the new ones are added (integer)</span>

<span class="sd">		Return values:</span>
<span class="sd">			error - the sum of squares error between the targeted sample distribution and the proposed sample distribution</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">error</span> <span class="o">=</span> <span class="mi">0</span>
		<span class="n">newtotal</span> <span class="o">=</span> <span class="n">newsamps</span><span class="o">+</span><span class="n">oldsamps</span>
		<span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">))</span> <span class="p">:</span>
			<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="n">oldsetcounts</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">*</span><span class="n">newsamps</span><span class="p">)</span><span class="o">/</span><span class="n">newtotal</span><span class="p">)</span>
			<span class="n">error</span> <span class="o">+=</span> <span class="n">val</span><span class="o">*</span><span class="n">val</span>
		<span class="k">return</span> <span class="n">error</span>

<span class="c">###################################### Main Program ###################################### </span>
</div></div>
<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&quot;__main__&quot;</span> <span class="p">:</span>
	<span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
	<span class="n">aa</span> <span class="o">=</span> <span class="n">EmailSamplesDB</span><span class="p">(</span><span class="s">r&quot;C:\Users\jcole119213\Documents\Python Scripts\LearningCurveApp\EmailSamplesDB_SQL.json&quot;</span><span class="p">,</span>
						<span class="s">r&quot;C:\Users\jcole119213\Documents\Python Scripts\LearningCurveApp\DBSetup_SQL.json&quot;</span><span class="p">)</span>
	<span class="n">aa</span><span class="o">.</span><span class="n">ConnectDB</span><span class="p">(</span><span class="s">r&quot;C:\Users\jcole119213\Documents\Python Scripts\LearningCurveApp\tester2.sqlite3&quot;</span><span class="p">)</span>
	<span class="k">print</span> <span class="s">&quot;Creating fresh database&quot;</span>
	<span class="n">aa</span><span class="o">.</span><span class="n">CreateDB</span><span class="p">()</span>
	<span class="k">print</span> <span class="s">&quot;Adding good email messages&quot;</span>
	<span class="n">aa</span><span class="o">.</span><span class="n">AddToDB</span><span class="p">(</span><span class="s">r&quot;C:\Users\jcole119213\Documents\Python Scripts\LearningCurveApp\EmailSamples\easy_ham&quot;</span><span class="p">,</span><span class="s">&quot;Legitimate Email&quot;</span><span class="p">,[</span><span class="o">.</span><span class="mi">6</span><span class="p">,</span><span class="o">.</span><span class="mi">2</span><span class="p">,</span><span class="o">.</span><span class="mi">2</span><span class="p">])</span>
	<span class="k">print</span> <span class="s">&quot;Adding spam email messages&quot;</span>
	<span class="n">aa</span><span class="o">.</span><span class="n">AddToDB</span><span class="p">(</span><span class="s">r&quot;C:\Users\jcole119213\Documents\Python Scripts\LearningCurveApp\EmailSamples\spam&quot;</span><span class="p">,</span><span class="mi">1</span><span class="p">,[</span><span class="o">.</span><span class="mi">6</span><span class="p">,</span><span class="o">.</span><span class="mi">2</span><span class="p">,</span><span class="o">.</span><span class="mi">2</span><span class="p">])</span>
	<span class="k">print</span> <span class="s">&quot;Creating fresh dictionary&quot;</span>
	<span class="n">DictRef</span> <span class="o">=</span> <span class="n">aa</span><span class="o">.</span><span class="n">CreateDict</span><span class="p">(</span><span class="s">&#39;My first dictionary&#39;</span><span class="p">)</span>
	<span class="k">print</span> <span class="s">&quot;Updating word histograms&quot;</span>
	<span class="n">aa</span><span class="o">.</span><span class="n">UpdateDict</span><span class="p">(</span><span class="n">DictRef</span><span class="p">,</span><span class="s">&quot;SelectNewTrainingBodies&quot;</span><span class="p">)</span>
	<span class="k">print</span> <span class="s">&quot;Creating a feature vector word list&quot;</span>
	<span class="n">WordListRef</span> <span class="o">=</span> <span class="n">aa</span><span class="o">.</span><span class="n">CreateWordList</span><span class="p">(</span><span class="s">&quot;Test word list&quot;</span><span class="p">,</span><span class="n">DictRef</span><span class="p">)</span>
	<span class="k">print</span> <span class="s">&quot;Updating the word list&quot;</span>
	<span class="n">aa</span><span class="o">.</span><span class="n">UpdateWordList</span><span class="p">(</span><span class="n">WordListRef</span><span class="p">)</span>
	<span class="k">print</span> <span class="s">&quot;Loading a word list from file&quot;</span>
	<span class="n">dict_id</span> <span class="o">=</span> <span class="n">aa</span><span class="o">.</span><span class="n">LoadWords</span><span class="p">(</span><span class="s">r&quot;C:\Users\jcole119213\Documents\Python Scripts\vocab.txt&quot;</span><span class="p">)</span>
	<span class="n">list_id</span> <span class="o">=</span> <span class="n">aa</span><span class="o">.</span><span class="n">CreateWordList</span><span class="p">(</span><span class="s">&quot;Words from vocab.txt&quot;</span><span class="p">,</span><span class="n">dict_id</span><span class="p">)</span>
	<span class="n">aa</span><span class="o">.</span><span class="n">UpdateWordList</span><span class="p">(</span><span class="n">list_id</span><span class="p">,</span><span class="bp">False</span><span class="p">)</span>
	<span class="k">print</span> <span class="s">&quot;Making the feature vectors&quot;</span>
	<span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
	<span class="n">aa</span><span class="o">.</span><span class="n">MakeFeatureVecs</span><span class="p">(</span><span class="n">WordListRef</span><span class="p">,</span><span class="s">&quot;SelectBodies&quot;</span><span class="p">)</span>
	<span class="n">elapsed_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
	<span class="k">print</span> <span class="s">&quot;Elapsed time:&quot;</span><span class="p">,</span><span class="n">elapsed_time</span><span class="p">,</span><span class="s">&#39;s&#39;</span>
	<span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
	<span class="n">aa</span><span class="o">.</span><span class="n">MakeFeatureVecs</span><span class="p">(</span><span class="n">list_id</span><span class="p">,</span><span class="s">&quot;SelectBodies&quot;</span><span class="p">)</span>
	<span class="n">elapsed_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
	<span class="k">print</span> <span class="s">&quot;Elapsed time:&quot;</span><span class="p">,</span><span class="n">elapsed_time</span><span class="p">,</span><span class="s">&#39;s&#39;</span>
	<span class="c">#print &quot;Write a word list to a file&quot;</span>
	<span class="c">#FileName = r&quot;C:\Users\jcole119213\Documents\Python Scripts\LearningCurveApp\TestDict.txt&quot;</span>
	<span class="c">#aa.WriteWords(&quot;wordlist0&quot;,FileName)</span>
	<span class="c">#print &quot;Reset the database&quot;</span>
	<span class="c">#aa.ResetDB()</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../index.html">LearningCurveApp 1.0 documentation</a> &raquo;</li>
          <li><a href="index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2016, Joseph R. Cole.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.3.
    </div>
  </body>
</html>